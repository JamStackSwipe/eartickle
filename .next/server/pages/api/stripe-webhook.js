"use strict";(()=>{var e={};e.id=550,e.ids=[550],e.modules={4217:e=>{e.exports=require("micro")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},3610:e=>{e.exports=import("@vercel/postgres")},6090:e=>{e.exports=import("stripe")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},2507:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>d,default:()=>l,routeModule:()=>u});var n=a(1802),o=a(7153),s=a(6249),i=a(1176),c=e([i]);i=(c.then?(await c)():c)[0];let l=(0,s.l)(i,"default"),d=(0,s.l)(i,"config"),u=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/stripe-webhook",pathname:"/api/stripe-webhook",bundlePath:"",filename:""},userland:i});r()}catch(e){r(e)}})},1176:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>l,default:()=>c});var n=a(6090),o=a(4217),s=a(3610),i=e([n,s]);[n,s]=i.then?(await i)():i;let l={api:{bodyParser:!1}},d=new n.default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"});async function c(e,t){let a;if("POST"!==e.method)return t.status(405).send("Method Not Allowed");let r=e.headers["stripe-signature"];try{let t=await (0,o.buffer)(e);a=d.webhooks.constructEvent(t,r,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("❌ Webhook signature failed:",e.message),t.status(400).send(`Webhook Error: ${e.message}`)}if("checkout.session.completed"===a.type){let e=a.data.object,{user_id:r,amount:n,songId:o,artistId:i,senderId:c}=e.metadata||{},l=parseInt(n,10);if(console.log("✅ Stripe Webhook: Payment complete"),console.log("\uD83D\uDC64 User ID:",r),console.log("\uD83D\uDCB0 Amount:",l),console.log("\uD83E\uDDFE Session ID:",e.id),!r||isNaN(l))return console.warn("⚠️ Missing or invalid metadata:",e.metadata),t.status(400).send("Invalid metadata");try{let{rows:a}=await (0,s.sql)`
        SELECT id 
        FROM tickle_transactions 
        WHERE stripe_payment_id = ${e.id}
      `;if(a.length>0)return console.warn("⚠️ Duplicate Stripe session detected. Skipping insert."),t.status(200).json({received:!0,duplicate:!0});await (0,s.sql)`
        UPDATE profiles 
        SET tickle_balance = tickle_balance + ${l}
        WHERE id = ${r}
      `,await (0,s.sql)`
        INSERT INTO tickle_transactions (sender_id, receiver_id, amount, stripe_payment_id)
        VALUES (${r}, ${r}, ${l}, ${e.id})
      `,console.log("✅ Tickle purchase recorded and balance updated.")}catch(e){return console.error("❌ Failed to process tickle purchase:",e.message),t.status(500).send("Database operation failed")}}return t.status(200).json({received:!0})}r()}catch(e){r(e)}})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=2507);module.exports=a})();